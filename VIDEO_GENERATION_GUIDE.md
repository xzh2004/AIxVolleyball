# 🎥 视频生成功能说明

## ⚠️ 重要提示

视频生成功能需要对每一帧进行AI姿态分析，**这需要较长时间**，请耐心等待。

---

## ⏱️ 预计处理时间

| 视频时长 | 帧数 | 预计时间 |
|---------|------|---------|
| 3秒 | ~90帧 | 20-40秒 |
| 5秒 | ~150帧 | 30-60秒 |
| 10秒 | ~300帧 | 60-120秒 |
| >10秒 | 自动采样到300帧 | 60-120秒 |

**注意**: 实际时间取决于您的电脑性能。

---

## 🎬 浏览器播放兼容性

### ⚠️ 重要提示

为了确保生成的视频能在浏览器中直接播放，系统会自动转换为H.264编码格式。

### 推荐安装FFmpeg（强烈推荐）

**FFmpeg能提供最佳的浏览器兼容性**

#### Windows安装
```bash
# 使用conda（推荐）
conda install ffmpeg

# 或使用pip
pip install ffmpeg-python

# 或从官网下载
# https://ffmpeg.org/download.html
```

#### Linux安装
```bash
# Ubuntu/Debian
sudo apt-get install ffmpeg

# CentOS/RHEL
sudo yum install ffmpeg
```

#### Mac安装
```bash
brew install ffmpeg
```

### 没有FFmpeg会怎样？

如果没有安装FFmpeg，系统会使用OpenCV的备用方案：
- ✅ 视频仍然会生成
- ⚠️ 但在某些浏览器中可能无法播放
- ⚠️ 需要下载后用播放器查看

**建议**: 安装FFmpeg以获得最佳体验

---

## 🔍 处理流程

### 1. 视频读取 (5-10秒)
- 读取视频文件
- 提取所有帧
- 帧数过多时自动采样

### 2. 姿态分析 (20-90秒) ⭐ **最耗时**
- 使用MediaPipe对每一帧进行AI姿态检测
- 识别33个身体关键点
- 计算骨架连接

### 3. 视频合成 (5-20秒)
- 将姿态骨架绘制到视频帧上
- 编码生成视频文件

### 4. 保存输出 (1-5秒)
- 保存到output目录
- 准备下载

---

## 💡 如何判断系统是否在工作

### 方法1: 查看控制台输出（推荐）

如果你从命令行启动的系统，可以看到详细的进度信息：

```bash
streamlit run app.py
```

你会看到类似输出：
```
🎬 开始生成视频: overlay
📹 视频信息: 450 帧, 30.0 FPS
⚡ 帧数过多，每 2 帧采样一次
✅ 提取了 225 帧
🔍 开始姿态分析...
✅ 姿态分析完成
🎨 开始生成 overlay 视频...
🎉 视频生成完成: output/xxx.mp4
```

### 方法2: 检查任务管理器

- Windows: 打开任务管理器，查看Python进程CPU使用率
- 如果CPU使用率在50-100%，说明正在处理
- 如果CPU使用率接近0%，可能卡住了

### 方法3: 等待时间

- 如果等待超过3分钟仍无响应，可能出现问题
- 建议刷新页面重试，或使用更短的视频

---

## 🚀 优化建议

### 1. 使用较短的视频
- **推荐**: 3-10秒的视频片段
- **避免**: 超过30秒的长视频
- 原因: 处理时间与帧数成正比

### 2. 降低视频分辨率
- 720p或更低的分辨率即可
- 不影响姿态检测效果
- 但能显著提高处理速度

### 3. 简化背景
- 简洁的背景有助于更快的姿态检测
- 避免复杂、杂乱的背景

### 4. 选择合适的可视化类型

**处理速度排序**（从快到慢）：
1. 🦴 **纯骨架** - 最快（不需要处理原始帧）
2. 🎥 **骨架叠加** - 较快
3. 📊 **左右对比** - 较慢（需要处理两倍的画面）
4. 📈 **轨迹追踪** - 最慢（需要绘制轨迹）

---

## ❌ 常见问题

### Q1: 一直卡在"正在生成"？

**可能原因**:
1. 视频太长，需要更多时间
2. 电脑性能较低
3. MediaPipe库加载缓慢

**解决方案**:
- 查看控制台输出确认是否在运行
- 等待更长时间（最多3分钟）
- 使用更短的视频
- 重启应用

### Q2: 生成失败怎么办？

**常见错误**:
1. 视频格式不支持 → 转换为MP4格式
2. 文件损坏 → 重新录制视频
3. 内存不足 → 使用更短的视频

**解决步骤**:
```bash
# 1. 查看错误信息
# 2. 检查视频文件
# 3. 重新上传较小的视频
# 4. 重启应用
```

### Q3: 能否加快处理速度？

**目前的优化**:
- ✅ 已限制最大帧数为300
- ✅ 长视频自动采样
- ✅ 优化了视频编码

**未来改进**:
- GPU加速（需要CUDA）
- 多线程并行处理
- 更轻量的姿态模型

### Q4: 生成的视频在哪里？

**保存位置**:
- 项目目录下的 `output/` 文件夹
- 文件名格式: `vis_[类型]_[原文件名]`
- 可以直接下载

---

## 🔧 技术细节

### 为什么这么慢？

**主要耗时操作**:
1. **MediaPipe姿态检测**: 每帧约0.1-0.5秒
   - 深度神经网络推理
   - 33个关键点定位
   - 需要CPU密集计算

2. **视频编码**: 每帧约0.02-0.1秒
   - 压缩算法
   - 格式转换

**示例计算**:
```
10秒视频 @ 30fps = 300帧
姿态检测: 300 × 0.2秒 = 60秒
视频编码: 300 × 0.05秒 = 15秒
总计: 约75秒
```

### 系统架构

```
用户上传视频
    ↓
VideoGenerator.generate_video()
    ↓
1. 读取视频帧
    ↓
2. SequenceAnalyzer.analyze_sequence()  ← 最耗时
   └─ PoseDetector.detect_pose() × N帧
    ↓
3. create_[type]_video()
   └─ 绘制骨架 + 视频编码
    ↓
保存到output/
```

---

## 📊 性能基准

**测试环境**: Intel i5-8代, 16GB RAM, 无GPU

| 视频 | 分辨率 | 帧数 | 实际时间 |
|------|--------|------|---------|
| 3秒片段 | 720p | 90 | 28秒 |
| 5秒片段 | 720p | 150 | 45秒 |
| 10秒片段 | 1080p | 300 | 95秒 |
| 30秒片段 | 1080p | 300(采样) | 98秒 |

---

## 💡 最佳实践

### ✅ 推荐做法
1. **录制5-10秒的短视频**
2. **使用720p分辨率**
3. **正面拍摄，全身入镜**
4. **简洁背景**
5. **从命令行启动，查看进度**
6. **首次使用选择"纯骨架"类型（最快）**

### ❌ 避免做法
1. ❌ 上传超过30秒的长视频
2. ❌ 使用4K分辨率
3. ❌ 复杂背景（多人、杂乱）
4. ❌ 同时生成多个视频
5. ❌ 在低配置电脑上处理

---

## 🎯 总结

视频生成是一个**计算密集型操作**，需要耐心等待：

- ⏱️ **正常等待时间**: 30秒 - 2分钟
- 🔍 **查看进度**: 控制台输出
- 📹 **推荐视频**: 3-10秒，720p
- 💻 **处理位置**: 本地CPU（无需联网）
- 🎨 **最快类型**: 纯骨架模式

**如果等待超过3分钟**，建议刷新页面重试，或使用更短的视频。

---

**更新日期**: 2025-10-31  
**版本**: v3.0.4

